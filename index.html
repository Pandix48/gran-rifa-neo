<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gran Rifa — Netlify</title>
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#111827;--ring:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    header{padding:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--ring)}
    h1{font-size:16px;margin:0}
    #status{font-size:14px;color:var(--muted)}
    main{max-width:1100px;margin:18px auto;padding:0 18px}

    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px}

    /* Controles */
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0}
    label{font-size:14px;color:var(--muted)}
    input[type="number"],select,textarea{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;font-size:14px;background:#fff;color:var(--text)}
    textarea{width:100%;min-height:120px}
    button{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:9px 12px;font-size:14px;cursor:pointer}
    button.ghost{background:#0f172a0d;color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Tablero */
    .board{margin-top:16px;display:grid;grid-gap:12px}
    .cell{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:10px 12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .cell h4{margin:0 0 6px 0;font-size:14px;font-weight:600}
    .shapes{display:flex;gap:6px;flex-wrap:wrap}
    .shape svg{width:20px;height:20px;display:block;opacity:.35}
    .shape.filled svg{opacity:1;filter:drop-shadow(0 0 1px rgba(0,0,0,.2))}
    .shape.star   svg path   {fill:#f59e0b} /* amarillo */
    .shape.circle svg circle {fill:#60a5fa} /* celeste  */
    .shape.diamond svg path  {fill:#34d399} /* verde    */

    /* Ganadores */
    table{width:100%;border-collapse:collapse}
    td,th{border-top:1px solid var(--ring);padding:10px;font-size:14px}
    #emptyMsg{color:var(--muted);font-size:14px;margin:6px 0}
  </style>
</head>
<body>
  <header>
    <h1>Gran Rifa — Netlify</h1>
    <span id="status">Cargando…</span>
  </header>

  <main>
    <!-- Controles (se ocultan si no hay ?admin=1 en la URL) -->
    <section id="controls" class="card" style="display:none">
      <h2 style="font-size:18px;margin:0 0 8px 0">Controles (admin)</h2>

      <div class="row">
        <label>Celdas</label>
        <input id="numCells" type="number" min="1" value="20" />
        <label>Formas / celda</label>
        <input id="numShapes" type="number" min="1" value="2" />
        <label>Forma</label>
        <select id="shapeType">
          <option value="star">Estrella</option>
          <option value="circle">Círculo</option>
          <option value="diamond">Diamante</option>
        </select>
        <label>Intervalo (seg)</label>
        <input id="intervalSec" type="number" min="1" value="5" />
      </div>

      <div class="row">
        <button id="btnGenerate">Generar tablero</button>
        <button id="btnReset" class="ghost">Reset</button>
        <button id="btnStart" class="ghost">Start</button>
        <button id="btnStop"  class="ghost">Stop</button>
        <button id="btnNext"  class="ghost">Next</button>
        <button id="btnAddPrize" class="ghost">Añadir premio</button>
      </div>

      <div class="row" style="flex-direction:column;align-items:stretch">
        <label>Nombres (uno por línea)</label>
        <textarea id="namesText" placeholder="Escribe cada nombre en una nueva línea…"></textarea>
        <div class="row"><button id="btnSaveNames" class="ghost">Guardar nombres</button></div>
      </div>
    </section>

    <!-- Tablero -->
    <section class="card">
      <div id="board" class="board"></div>
    </section>

    <!-- Resumen -->
    <section class="card" style="margin-top:16px">
      <h2 style="font-size:18px;margin:0 0 8px 0">Resumen</h2>
      <div id="emptyMsg">Sin ganador aún</div>
      <table>
        <thead><tr><th style="width:60px">#</th><th>Ganador</th></tr></thead>
        <tbody id="winnersBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ====== Utilidades ======
    const qs = (s, r=document) => r.querySelector(s);
    const statusEl    = qs('#status');
    const boardEl     = qs('#board');
    const winnersBody = qs('#winnersBody');
    const emptyMsg    = qs('#emptyMsg');

    // Admin flag (?admin=1) y room (?room=xxx)
    const urlp   = new URLSearchParams(location.search);
    const isAdmin= urlp.get('admin') === '1';
    const room   = (urlp.get('room') || 'demo').trim();

    if (isAdmin) qs('#controls').style.display = 'block';

    // ====== Dibujar tablero ======
    function shapeSVG(type) {
      if (type === 'circle') {
        return `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>`;
      }
      if (type === 'diamond') {
        return `<svg viewBox="0 0 24 24"><path d="M12 2 L22 12 L12 22 L2 12 Z"/></svg>`;
      }
      return `<svg viewBox="0 0 24 24"><path d="M12 2l2.95 6.31 6.92.56-5.26 4.48 1.64 6.74L12 16.9 5.75 20.1l1.64-6.74L2.13 8.87l6.92-.56L12 2z"/></svg>`;
    }
    const gridCols = n => Math.ceil(Math.sqrt(n));

    function render(state) {
      if (!state) {
        statusEl.textContent = 'Esperando estado…';
        boardEl.innerHTML = '';
        winnersBody.innerHTML = '';
        emptyMsg.style.display = 'block';
        return;
      }

      const marcadas = (state.filledCounts || []).filter(c => c >= (state.numShapes||1)).length;
      const shapeTxt = (state.shapeType || state.shape || 'star');
      statusEl.textContent =
        `Estado: forma=${shapeTxt} | celdas=${state.numCells} | formas/celda=${state.numShapes} | marcadas=${marcadas} | corriendo=${!!state.running}`;

      // Pintar tablero
      const n    = state.numCells || 20;
      const cols = gridCols(n);
      boardEl.style.gridTemplateColumns = `repeat(${cols}, minmax(120px, 1fr))`;
      boardEl.innerHTML = '';

      for (let i = 0; i < n; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';

        const name = (state.names && state.names[i]) ? state.names[i] : `#${i+1}`;
        const h4 = document.createElement('h4');
        h4.textContent = name;
        cell.appendChild(h4);

        const shapesWrap = document.createElement('div');
        shapesWrap.className = 'shapes';

        const totalShapes = state.numShapes || 2;
        const filled = (state.filledCounts && state.filledCounts[i]) || 0;
        const type = (state.shapeType || state.shape || 'star');

        for (let j = 0; j < totalShapes; j++) {
          const d = document.createElement('div');
          d.className = `shape ${type} ${j < filled ? 'filled' : ''}`;
          d.innerHTML = shapeSVG(type);
          shapesWrap.appendChild(d);
        }

        cell.appendChild(shapesWrap);
        boardEl.appendChild(cell);
      }

      // Ganadores
      const winners = state.winners || [];
      winnersBody.innerHTML = '';
      if (winners.length === 0) emptyMsg.style.display = 'block';
      else emptyMsg.style.display = 'none';

      winners.forEach((w, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${(w.name || ('#'+(w.number||'-')))} — ${w.prize||'Premio'}</td>`;
        winnersBody.appendChild(tr);
      });
    }

    // ====== Llamadas al backend ======
    async function call(action, payload={}) {
      const res = await fetch('/.netlify/functions/state', {
        method: 'POST',
        headers: { 'content-type':'application/json' },
        body: JSON.stringify({ room, action, ...payload })
      });
      const data = await res.json().catch(()=>({}));
      if (!data.ok) throw new Error(data.error||'Error');
      return data.state;
    }

    async function fetchState() {
      const url = new URL('/.netlify/functions/state', location.origin);
      url.searchParams.set('room', room);
      const res = await fetch(url.toString());
      const data = await res.json().catch(()=>({}));
      if (data && data.ok) return data.state || null;
      return null;
    }

    // ====== Polling ======
    async function poll() {
      try {
        const state = await fetchState();
        render(state);
      } catch { /* ignore */ }
    }
    poll();
    setInterval(poll, 1000);

    // ====== Eventos admin ======
    if (isAdmin) {
      qs('#btnGenerate').onclick = async () => {
        const n = parseInt(qs('#numCells').value||'20',10);
        const k = parseInt(qs('#numShapes').value||'2',10);
        const shape = qs('#shapeType').value||'star';
        const intervalMs = Math.max(1000, parseInt((qs('#intervalSec').value||'5'),10)*1000);
        await call('generate', { n, k, shape, intervalMs });
        poll();
      };
      qs('#btnReset').onclick = async () => { await call('reset'); poll(); };
      qs('#btnStart').onclick = async () => { await call('start'); poll(); };
      qs('#btnStop').onclick  = async () => { await call('stop');  poll(); };
      qs('#btnNext').onclick  = async () => { await call('next');  poll(); };

      qs('#btnAddPrize').onclick = async () => {
        const prize = prompt('Nombre del premio:');
        if (!prize) return;
        await call('addPrize', { prize });
        poll();
      };

      qs('#btnSaveNames').onclick = async () => {
        const raw = (qs('#namesText').value || '').trim();
        const names = raw.split('\n').map(s => s.trim()).filter(Boolean);
        await call('setNames', { names });
        poll();
      };
    }
  </script>
</body>
</html>

