<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gran Rifa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
    header { background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; position:sticky; top:0; z-index:5; }
    h1 { margin:0; font-size:16px; }
    #status { color:#6b7280; font-size:13px; }
    .wrap { max-width:1100px; margin:16px auto; padding:0 16px; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input,select,button { font:inherit; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
    input[type="number"]{ width:90px; }
    button { cursor:pointer; }
    .primary{ background:#2563eb; color:#fff; border-color:transparent; }
    .good{ background:#16a34a; color:#fff; border-color:transparent; }
    .bad{ background:#dc2626; color:#fff; border-color:transparent; }

    table { margin: 12px auto; border-collapse: collapse; width:100%; max-width:1000px; }
    td { border: 1px solid #e5e7eb; padding: 10px; min-width: 120px; text-align: center; background:#fff; border-radius:8px; }
    .cell-header { font-weight: bold; margin-bottom: 5px; color:#374151; font-size:13px; }
    .name-input { width: 95%; padding: 6px 8px; margin-top: 5px; border:1px solid #e5e7eb; border-radius:8px; }
    .shapes { display: flex; justify-content: center; flex-wrap: wrap; gap: 4px; margin-top:6px; }
    .shape { width: 20px; height: 20px; opacity: 0.25; }
    .shape.filled { opacity: 1; }
    .star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); background: #fbbf24; }
    .circle { border-radius: 50%; background: #60a5fa; }
    .diamond { background: #a78bfa; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
    .muted { color:#6b7280; font-size:13px; }
    .winner { font-size: 1.2em; color: #16a34a; margin-top: 8px; text-align:center; }
    #controls{ display:none; }
    .prize { margin: 6px 0; }
    .remove-btn { margin-left: 10px; color: #dc2626; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Gran Rifa</h1>
      <div id="status" class="muted">Cargando‚Ä¶</div>
    </div>
  </header>

  <div class="wrap">

    <!-- Controles (solo admin con ?admin=1) -->
    <section id="controls" class="panel">
      <div class="row">
        <div> N√∫mero de celdas: <input type="number" id="numCells" value="20" min="1"></div>
        <div> Formas por celda: <input type="number" id="numShapes" value="2" min="1"></div>
        <div> Tipo de forma:
          <select id="shapeType">
            <option value="star">‚≠ê Estrella</option>
            <option value="circle">‚ö™ C√≠rculo</option>
            <option value="heart">‚ù§Ô∏è Coraz√≥n</option><!-- se mapear√° a diamond -->
            <option value="diamond">üíé Diamante</option>
          </select>
        </div>
        <div> Intervalo (segundos): <input type="number" id="interval" value="5" min="1"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnGenerate" class="primary">Generar</button>
        <button id="btnReset">Reset</button>
        <button id="btnStart" class="good">Iniciar</button>
        <button id="btnStop" class="bad">Detener</button>
        <button id="btnNext">Next</button>
      </div>
    </section>

    <section class="panel">
      <div id="prizes"></div>
      <button id="btnAddPrize" class="primary">A√±adir Premio</button>
      <div class="winner" id="winner"></div>
    </section>

    <section class="panel">
      <table id="raffleTable"></table>
      <div id="emptyMsg" class="muted" style="text-align:center; margin-top:6px">Sin datos todav√≠a‚Ä¶</div>
    </section>
  </div>

  <script>
    // ====== B√°sicos / entorno ======
    const qs = (s,r=document)=>r.querySelector(s);
    const statusEl = qs('#status');
    const tableEl  = qs('#raffleTable');
    const emptyMsg = qs('#emptyMsg');
    const prizesDiv= qs('#prizes');
    const winnerEl = qs('#winner');

    const urlp     = new URLSearchParams(location.search);
    const room     = (urlp.get('room') || 'demo').trim();
    const isAdmin  = urlp.get('admin') === '1';
    if (isAdmin) qs('#controls').style.display = 'block';

    const numCellsEl = qs('#numCells');
    const numShapesEl= qs('#numShapes');
    const shapeTypeEl= qs('#shapeType');
    const intervalEl = qs('#interval');

    const btnGenerate= qs('#btnGenerate');
    const btnReset   = qs('#btnReset');
    const btnStart   = qs('#btnStart');
    const btnStop    = qs('#btnStop');
    const btnNext    = qs('#btnNext');
    const btnAddPrize= qs('#btnAddPrize');

    // ====== Voz ======
    function speak(text){
      try{
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-ES';
        speechSynthesis.speak(u);
      }catch{}
    }

    // ====== Backend ======
    async function call(action, payload={}){
      const res = await fetch('/.netlify/functions/state', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify({ room, action, ...payload })
      });
      const data = await res.json().catch(()=>({}));
      if (!data.ok) throw new Error(data.error || 'Error');
      return data.state;
    }
    async function fetchState(){
      try{
        const url = new URL('/.netlify/functions/state', location.origin);
        url.searchParams.set('room', room);
        const res = await fetch(url.toString());
        const data = await res.json().catch(()=>({}));
        if (data && data.ok) return data.state || null;
        return null;
      }catch{ return null; }
    }

    // ====== Render ======
    let lastWinnersCount = 0;
    function mapShapeToAllowed(v){
      // Backend s√≥lo acepta star|circle|diamond
      if (v === 'heart') return 'diamond';
      return (['star','circle','diamond'].includes(v) ? v : 'star');
    }

    function render(state){
      if (!state){
        statusEl.textContent = 'Esperando estado‚Ä¶';
        tableEl.innerHTML = '';
        emptyMsg.style.display = 'block';
        winnerEl.textContent = '';
        return;
      }
      emptyMsg.style.display = 'none';

      const n = Number.isFinite(state.numCells) ? state.numCells : 20;
      const totalShapes = Number.isFinite(state.numShapes) ? state.numShapes : 2;
      const type = (state.shapeType || state.shape || 'star');
      const marcadas = (state.filledCounts||[]).filter(c => Number.isFinite(c) && c >= totalShapes).length;
      statusEl.textContent = `forma=${type} | celdas=${n} | formas/celda=${totalShapes} | marcadas=${marcadas} | corriendo=${!!state.running}`;

      // Pintar tablero (5 columnas por fila)
      tableEl.innerHTML = '';
      let row;
      for (let i=1;i<=n;i++){
        if ((i-1)%5===0) row = tableEl.insertRow();
        const cell = row.insertCell();

        const name = (state.names && state.names[i-1]) ? state.names[i-1] : `#${i}`;
        cell.innerHTML = `
          <div class="cell-header">#${i}</div>
          ${isAdmin ? `<input class="name-input" type="text" value="${name}" data-index="${i-1}">`
                    : `<div class="name-input" style="border:none">${name}</div>`}
          <div class="shapes"></div>
        `;
        const shapesWrap = cell.querySelector('.shapes');
        const filled = Number.isFinite(state.filledCounts?.[i-1]) ? state.filledCounts[i-1] : 0;
        for (let j=0;j<totalShapes;j++){
          const d = document.createElement('div');
          d.className = `shape ${type} ${j<filled ? 'filled':''}`;
          shapesWrap.appendChild(d);
        }
      }

      // Guardado de nombres (on blur / Enter)
      if (isAdmin){
        tableEl.querySelectorAll('.name-input').forEach(inp=>{
          inp.addEventListener('keydown', e=>{
            if (e.key==='Enter'){ e.preventDefault(); inp.blur(); }
          });
          inp.addEventListener('blur', async ()=>{
            try{
              const idx = parseInt(inp.dataset.index,10);
              const names = state.names ? [...state.names] : Array.from({length:n}, (_,k)=>`#${k+1}`);
              names[idx] = inp.value.trim() || `#${idx+1}`;
              await call('setNames',{ names });
              poll(); // refresca
            }catch{}
          });
        });
      }

      // Premios
      drawPrizes(state.prizes || []);

      // Ganadores (√∫ltimo)
      const winners = state.winners || [];
      if (winners.length){
        const last = winners[winners.length-1];
        winnerEl.textContent = `üéâ Ganador: ${last.name || ('#'+(last.number||'?'))} - ${last.prize || 'Premio'}`;
      } else {
        winnerEl.textContent = '';
      }

      // Voz al nuevo ganador
      if (isAdmin && winners.length > lastWinnersCount){
        const nw = winners[winners.length-1];
        const num = nw?.number ?? '?';
        const prize = nw?.prize ?? 'premio';
        speak(`N√∫mero ${num}, felicidades, ganaste ${prize}`);
      }
      lastWinnersCount = winners.length;
    }

    function drawPrizes(list){
      prizesDiv.innerHTML = '';
      list.forEach((p, idx)=>{
        const div = document.createElement('div');
        div.className = 'prize';
        div.innerHTML = `Premio ${idx+1}: <input type="text" value="${p}"> <span class="remove-btn">‚úñ</span>`;
        const input = div.querySelector('input');
        const del   = div.querySelector('.remove-btn');
        input.addEventListener('change', async ()=>{
          const current = Array.from(prizesDiv.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
          await call('setPrizes', { prizes: current });
          poll();
        });
        del.addEventListener('click', async ()=>{
          await call('removePrize', { index: idx });
          poll();
        });
        prizesDiv.appendChild(div);
      });
    }

    // ====== Auto-next (admin local) ======
    let autoNextTimer = null;
    let autoNextEvery = null;
    function clearAutoNext(){
      if (autoNextTimer){ clearInterval(autoNextTimer); autoNextTimer=null; }
      autoNextEvery = null;
    }
    async function ensureAutoNext(state){
      if (!isAdmin){ clearAutoNext(); return; }
      if (!state?.running){ clearAutoNext(); return; }
      const ms = Math.max(1000, Number(state?.intervalMs)||5000);
      if (autoNextEvery !== ms){
        clearAutoNext();
        autoNextEvery = ms;
        autoNextTimer = setInterval(async ()=>{
          try{
            const s = await call('next');
            if (!s || (s.availableNumbers||[]).length===0) clearAutoNext();
          }catch(e){ console.warn('auto-next error', e); }
        }, ms);
      }
    }

    // ====== Poll ======
    let didAutoInit = false;
    async function poll(){
      try{
        const s = await fetchState();
        if (!s && isAdmin && !didAutoInit){
          didAutoInit = true;
          const n  = parseInt(numCellsEl?.value  || '20',10);
          const k  = parseInt(numShapesEl?.value || '2',10);
          const shSel = (shapeTypeEl?.value || 'star');
          const sh   = mapShapeToAllowed(shSel); // mapear heart->diamond
          const intervalMs = Math.max(1000, parseInt((intervalEl?.value || '5'),10)*1000);
          await call('generate',{ n, k, shape: sh, intervalMs });
          return;
        }
        // mantener auto-next acorde al estado
        ensureAutoNext(s);
        render(s);
      }catch(e){ console.error(e); }
    }
    poll();
    setInterval(poll, 1000);

    // ====== Eventos ======
    if (isAdmin){
      btnGenerate?.addEventListener('click', async ()=>{
        clearAutoNext();
        const n  = parseInt(numCellsEl?.value  || '20',10);
        const k  = parseInt(numShapesEl?.value || '2',10);
        const sh = mapShapeToAllowed(shapeTypeEl?.value || 'star');
        const intervalMs = Math.max(1000, parseInt((intervalEl?.value || '5'),10)*1000);
        await call('generate', { n, k, shape: sh, intervalMs });
        poll();
      });
      btnReset?.addEventListener('click', async ()=>{
        clearAutoNext();
        await call('reset');
        poll();
      });
      btnStart?.addEventListener('click', async ()=>{
        await call('start');
        poll();
      });
      btnStop?.addEventListener('click', async ()=>{
        clearAutoNext();
        await call('stop');
        poll();
      });
      btnNext?.addEventListener('click', async ()=>{
        await call('next');
        poll();
      });
      btnAddPrize?.addEventListener('click', async ()=>{
        const div = document.createElement('div');
        div.className='prize';
        div.innerHTML = `Premio nuevo: <input type="text"> <span class="remove-btn">‚úñ</span>`;
        prizesDiv.appendChild(div);
        const inp = div.querySelector('input');
        inp.focus();
        // guarda al vuelo al escribir
        inp.addEventListener('change', async ()=>{
          const current = Array.from(prizesDiv.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
          // si a√∫n no escribe nada, no guardes
          if (current.length) await call('setPrizes', { prizes: current });
          poll();
        });
        // eliminar desde el DOM (se re-sincroniza en el pr√≥ximo poll)
        div.querySelector('.remove-btn').addEventListener('click', async ()=>{
          const current = Array.from(prizesDiv.querySelectorAll('.prize'));
          const idx = current.indexOf(div);
          if (idx>=0) await call('removePrize', { index: idx });
          poll();
        });
      });
    }
  </script>
</body>
</html>




