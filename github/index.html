<!-- fixed build -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gran Rifa ‚Äî Netlify + Neon (sin Firebase)</title>
  <style>
    body{font-family:Arial,system-ui,-apple-system,sans-serif;background:#f7fafc;margin:0;color:#111827;text-align:center}
    header{background:#111827;color:#fff;padding:14px 10px}
    h1{margin:0;font-size:20px}
    .wrap{padding:16px}
    .muted{color:#6b7280;font-size:12px}
    table{margin:16px auto;border-collapse:collapse}
    td{border:1px solid #cbd5e1;padding:10px;min-width:120px;text-align:center;background:#fff}
    .cell-header{font-weight:bold;margin-bottom:5px}
    .name{font-size:13px;margin-top:2px;color:#334155}
    .shapes{display:flex;justify-content:center;flex-wrap:wrap;gap:5px;margin-top:6px}
    .shape{width:20px;height:20px;opacity:.25}
    .shape.filled{opacity:1}
    .star{clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);background:gold}
    .circle{border-radius:50%;background:steelblue}
    .diamond{background:rebeccapurple;clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%)}
    .controls{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));max-width:1000px;margin:0 auto 10px}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;text-align:left}
    .panel h3{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    input,select,button{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
    button{cursor:pointer}
    .primary{background:#22c55e;color:#fff;border:0}
    .warn{background:#ef4444;color:#fff;border:0}
    .admin-only{display:none}
    .winner{font-size:1.2em;color:#065f46;margin:12px 0 4px}
    code{background:#eef2f7;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>Gran Rifa ‚Äî Netlify DB (modo <span id="modeLabel">viewer</span>)</h1>
  </header>

  <div class="wrap">
    <div id="status" class="muted">Conectando‚Ä¶</div>

    <!-- Controles de admin -->
    <div id="adminControls" class="controls admin-only" aria-hidden="true">
      <div class="panel">
        <h3>Configuraci√≥n</h3>
        <div class="row"><label style="width:40%">Celdas</label><input id="numCells" type="number" value="20" min="1" /></div>
        <div class="row"><label style="width:40%">Formas/celda</label><input id="numShapes" type="number" value="2" min="1" /></div>
        <div class="row"><label style="width:40%">Forma</label>
          <select id="shapeType">
            <option value="star">‚≠ê Estrella</option>
            <option value="circle">‚ö™ C√≠rculo</option>
            <option value="diamond">üíé Diamante</option>
          </select>
        </div>
        <div class="row"><label style="width:40%">Intervalo (seg)</label><input id="intervalSec" type="number" value="5" min="1" /></div>
        <div class="row">
          <button class="primary" id="btnGenerate">Generar tablero</button>
          <button id="btnReset">Reiniciar</button>
        </div>
      </div>

      <div class="panel">
        <h3>Participantes y premios</h3>
        <div class="row">
          <input id="bulkNames" type="text" placeholder="Nombres separados por coma (posici√≥n 1..N)" />
          <button id="btnSetNames">Cargar nombres</button>
        </div>
        <div class="row">
          <button id="btnAddPrize">A√±adir premio</button>
        </div>
      </div>

      <div class="panel">
        <h3>Control</h3>
        <div class="row">
          <button class="primary" id="btnStart">Iniciar</button>
          <button class="warn" id="btnStop">Detener</button>
          <button id="btnNext">Anunciar ahora</button>
        </div>
      </div>
      <p class="muted">Comparte el link con <code>?room=TU_SALA</code>. T√∫ controlas con <code>&admin=1</code>.</p>
    </div>

    <div id="winner" class="winner"></div>
    <table id="raffleTable" role="grid" aria-live="polite"></table>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const isAdmin = params.get('admin') === '1';
    const room = (params.get('room') || 'demo').trim() || 'demo';
    document.getElementById('modeLabel').textContent = isAdmin ? 'admin' : 'viewer';
    if (isAdmin) { const ac = document.getElementById('adminControls'); ac.classList.remove('admin-only'); ac.removeAttribute('aria-hidden'); }

    const statusEl = document.getElementById('status');
    const tableEl = document.getElementById('raffleTable');
    const winnerEl = document.getElementById('winner');

    function render(state){
      if (!state){ statusEl.textContent = `Sala: ${room} ¬∑ esperando estado‚Ä¶`; tableEl.innerHTML=''; winnerEl.textContent=''; return; }
      tableEl.innerHTML = '';
      const cols = 5;
      let rowEl;
      for(let i=1;i<=state.numCells;i++){
        if((i-1)%cols===0) rowEl = tableEl.insertRow();
        const cell = rowEl.insertCell();
        const filled = state.filledCounts[i-1] || 0;
        const shapes = Array.from({length: state.numShapes}, (_,s)=>`<div class="shape ${state.shapeType} ${s<filled?'filled':''}"></div>`).join('');
        cell.innerHTML = `<div class="cell-header">#${i}</div><div class="name">${state.names[i-1]||('#'+i)}</div><div class="shapes">${shapes}</div>`;
      }
      const last = (state.winners||[]).length ? state.winners[state.winners.length-1] : null;
      winnerEl.textContent = last ? `üéâ Ganador: ${last.name} ‚Äî ${last.prize||'Premio'}` : '';
      statusEl.textContent = `Sala: ${room} ¬∑ ${state.running? 'EN VIVO':'detenido'} ¬∑ Ganadores: ${(state.winners||[]).length}`;
    }

    // Polling: trae el estado cada 1500ms desde la Function (Netlify + Neon)
    let pollTimer = null;
    async function poll(){
      try{
        const res = await fetch('/.netlify/functions/state?room=' + encodeURIComponent(room));
        const data = await res.json();
        render(data.state || null);
      }catch(e){ statusEl.textContent = 'No se pudo leer estado.'; }
    }
    poll(); pollTimer = setInterval(poll, 1500);

    // --- Acciones admin ---
    async function call(action, payload={}){
      const res = await fetch('/.netlify/functions/state', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ room, action, ...payload })
      });
      return res.json();
    }

    if (isAdmin){
      document.getElementById('btnGenerate').onclick = ()=>{
        const n = parseInt(document.getElementById('numCells').value||'20');
        const k = parseInt(document.getElementById('numShapes').value||'2');
        const shape = document.getElementById('shapeType').value||'star';
        const intervalSec = Math.max(1, parseInt(document.getElementById('intervalSec').value||'5'));
        return call('generate', { n, k, shape, intervalMs: intervalSec*1000 });
      };
      document.getElementById('btnReset').onclick = ()=> call('reset', {});
      document.getElementById('btnStart').onclick = ()=> call('start', {});
      document.getElementById('btnStop').onclick = ()=> call('stop', {});
      document.getElementById('btnNext').onclick = ()=> call('next', {});
      document.getElementById('btnAddPrize').onclick = async ()=>{
        const txt = prompt('Nombre del premio:'); if(!txt) return;
        await call('addPrize', { prize: txt });
      };
      document.getElementById('btnSetNames').onclick = async ()=>{
        const raw = document.getElementById('bulkNames').value.trim(); if(!raw) return;
        const arr = raw.split(',').map(s=>s.trim()).filter(Boolean);
        await call('setNames', { names: arr });
      };
    }
  </script>
</body>
</html>
