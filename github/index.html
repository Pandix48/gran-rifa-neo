<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gran Rifa — Netlify DB (modo admin)</title>
  <style>
    body{font-family:system-ui, -apple-system, sans-serif;background:#f7fafc;margin:0;color:#111827}
    header{background:#111827;color:#fff;padding:14px}
    h1{margin:0;font-size:20px;text-align:center}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .muted{color:#6b7280}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin:14px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    label{min-width:140px;color:#374151}
    input, select, textarea{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px}
    textarea{min-height:120px}
    button{cursor:pointer;border:1px solid #94a3b8;background:#111827;color:#fff;border-radius:10px;padding:9px 12px}
    button.primary{background:#2563eb;border-color:#1d4ed8}
    .admin-only{display:none}
    table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb}
    td,th{border-top:1px solid #e5e7eb;padding:8px;text-align:left}
    code{background:#eef2ff;padding:2px 6px;border-radius:6px}
    .center{ text-align:center;color:#6b7280;margin:28px 0 }
  </style>
</head>
<body>
  <header>
    <h1>Gran Rifa — Netlify DB (modo <span id="modeLabel">admin</span>)</h1>
  </header>

  <div class="wrap">
    <div id="status" class="muted">Conectando…</div>

    <!-- Controles de admin -->
    <div id="adminControls" class="panel admin-only">
      <h3>Controles (admin)</h3>
      <div class="grid">

        <div class="row"><label for="numCells">Celdas</label>
          <input id="numCells" type="number" value="20" min="1" />
        </div>

        <div class="row"><label for="numShapes">Formas / celdas</label>
          <input id="numShapes" type="number" value="2" min="1" />
        </div>

        <div class="row"><label for="shapeType">Forma</label>
          <select id="shapeType">
            <option value="star">Estrella</option>
            <option value="circle">Círculo</option>
            <option value="diamond">Diamante</option>
          </select>
        </div>

        <div class="row"><label for="intervalSec">Intervalo (seg)</label>
          <input id="intervalSec" type="number" value="5" min="1" />
        </div>

        <div class="row">
          <button id="btnGenerate" class="primary">Generar tablero</button>
          <button id="btnReset">Reset</button>
          <button id="btnStart">Start</button>
          <button id="btnStop">Stop</button>
          <button id="btnNext">Next</button>
          <button id="btnAddPrize">Añadir premio</button>
        </div>

        <div class="row" style="grid-column:1/-1; align-items:flex-start;">
          <label for="txtBulkNames" style="min-width:180px;">Nombres (uno por línea)</label>
          <textarea id="txtBulkNames" placeholder="Escribe cada nombre en una nueva línea…"></textarea>
        </div>

        <div class="row">
          <button id="btnSetNames">Guardar nombres</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Resumen</h3>
      <div id="winner" class="row muted">—</div>
      <table id="winners" aria-live="polite">
        <thead><tr><th>#</th><th>Ganador</th></tr></thead>
        <tbody id="winnersBody"></tbody>
      </table>
    </div>

    <div id="emptyMsg" class="center" style="display:none;">No hay datos todavía.</div>
  </div>

  <script>
    // ========= CONFIG INICIAL =========
    // Fuerza modo admin
    const mode = "admin";
    const isAdmin = true;
    document.getElementById("modeLabel").textContent = mode;
    const adminPanel = document.getElementById("adminControls");
    adminPanel.classList.remove("admin-only");
    adminPanel.removeAttribute("aria-hidden");

    // Room desde la URL o "demo"
    const params = new URLSearchParams(location.search);
    const room = params.get("room") || "demo";

    // Elementos UI
    const statusEl = document.getElementById("status");
    const winnerEl = document.getElementById("winner");
    const winnersBody = document.getElementById("winnersBody");
    const emptyMsg = document.getElementById("emptyMsg");

    // ========= RENDER =========
    function render(state) {
      if (!state) {
        statusEl.textContent = "Esperando estado…";
        winnersBody.innerHTML = "";
        winnerEl.textContent = "—";
        emptyMsg.style.display = "block";
        return;
      }
      emptyMsg.style.display = "none";
      statusEl.textContent = `Estado: forma=${state.shape} | celdas ocupadas=${(state.filled||[]).length} | corriendo=${!!state.running}`;

      // Ganador actual (si hubiera)
      const current = (state.winners && state.winners.length) ? state.winners[state.winners.length - 1] : null;
      winnerEl.textContent = current ? `Ganador: ${current}` : "Sin ganador aún";

      // Tabla de ganadores
      winnersBody.innerHTML = "";
      (state.winners||[]).forEach((name, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${name}</td>`;
        winnersBody.appendChild(tr);
      });
    }

    // ========= CONSULTA (GET) =========
    async function fetchState() {
      try {
        const res = await fetch(`/.netlify/functions/state?room=${encodeURIComponent(room)}`);
        const data = await res.json();
        render(data.state || null);
      } catch (e) {
        statusEl.textContent = "No se pudo leer estado.";
        console.error(e);
      }
    }

    // Polling
    fetchState();
    let pollTimer = setInterval(fetchState, 1500);

    // ========= ACCIONES (POST) =========
    async function call(action, payload = {}) {
      const res = await fetch(`/.netlify/functions/state`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ room, action, payload })
      });
      return res.json();
    }

    // ========= BIND BOTONES ADMIN =========
    if (isAdmin) {
      const $ = (id) => document.getElementById(id);

      $("btnGenerate").onclick = () => {
        const n = parseInt($("numCells").value || "20", 10);
        const k = parseInt($("numShapes").value || "2", 10);
        const shape = $("shapeType").value || "star";
        const intervalSec = Math.max(1, parseInt($("intervalSec").value || "5", 10));
        return call("generate", { n, k, shape, intervalMs: intervalSec * 1000 });
      };

      $("btnReset").onclick = () => call("reset", {});
      $("btnStart").onclick = () => call("start", {});
      $("btnStop").onclick  = () => call("stop", {});
      $("btnNext").onclick  = () => call("next", {});

      $("btnAddPrize").onclick = async () => {
        const prize = prompt("Nombre del premio:");
        if (!prize) return;
        await call("addPrize", { prize });
      };

      $("btnSetNames").onclick = async () => {
        const raw = $("txtBulkNames").value.trim();
        if (!raw) return;
        const names = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        await call("setNames", { names });
      };
    }
  </script>
</body>
</html>
